---
title: '`voice` vignette'
subtitle: 'version `r packageVersion("voice")`'
author: 'Filipe J. Zabala'
date: "`r format(Sys.time(), '%Y-%m-%d')`"
# date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{`voice` vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
ini0 <- Sys.time()
```

## 0. Installation
https://github.com/filipezabala/voice


## 1. Extract features
### Load packages and audio files
```{r, message=FALSE, warning=FALSE}
# packs
library(voice)

# get path to audio file
wavDir <- list.files(system.file('extdata', package = 'wrassp'),
                     pattern = glob2rx('*.wav'), full.names = TRUE)
```

### Examples
```{r, message=FALSE, warning=FALSE}
# minimal usage
M <- voice::extract_features(wavDir)
M
```


## 2. Tag
```{r, message=FALSE, warning=FALSE}
# creating Extended synthetic data
E <- dplyr::tibble(subject_id = c(1,1,1,2,2,2,3,3,3), wav_path = wavDir)
E

# minimal usage
voice::tag(E)

# canonical data
voice::tag(E, groupBy = 'subject_id')
```

## 3. Voice2Sheet (experimental)
### 3.1. Extract features

#### Get audio {-}
```{r, message=FALSE, warning=FALSE}
url0 <- 'https://github.com/filipezabala/voiceAudios/blob/main/wav/doremi.wav?raw=true'
download.file(url0, paste0(tempdir(), '/doremi.wav'), mode = 'wb')
# embedr::embed_audio(url0)X
```

#### Extract features {-}
```{r, message=FALSE, warning=FALSE}
M <- voice::extract_features(tempdir(), features = 'f0', round.to = 6)
summary(M)
```

#### Plot
```{r, message=FALSE, warning=FALSE}
# Plot
plot(M$f0)
legend(-40, 170, 'Do (C)' , bty = 'n')
legend(100, 190, 'Re (D)' , bty = 'n')
legend(240, 290, 'Mi (E)' , bty = 'n')
legend(370, 220, 'Fa (F)' , bty = 'n')
legend(500, 250, 'Sol (G)', bty = 'n')
legend(620, 270, 'La (A)' , bty = 'n')
legend(770, 300, 'Si (B)' , bty = 'n')
legend(900, 320, 'Do (C)' , bty = 'n')
```


### 3.2. Music sheet
#### Compress to 1% {-}
```{r, message=FALSE, warning=FALSE}
# compress
M1 <- voice::interp_df(M, 0.01, id = 3)

# assign notes
M1$f0_spn <- voice::notes(M1$f0)

# duration
d1 <- voice::duration(M1$f0_spn)

# gm by Renfei Mao
library(gm)
m <- gm::Music()
m <- m +
  gm::Meter(4, 4) +
  gm::Line(pitches = as.list(as.character(d1$note)),
           durations = as.list(d1$dur_line)) +
  gm::Tempo(170)
gm::show(m, to = c('score', 'audio'))
```
