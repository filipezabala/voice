---
title: '`voice` vignette'
author: 'Filipe J. Zabala'
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{`voice` vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation
https://github.com/filipezabala/voice

## Example
### Load packages
```{r, message=FALSE, warning=FALSE}
# packs
library(voice)
library(tidyverse)
library(music)
library(gm)
```
### Set directories
```{r}
vaDir <- '~/Downloads/voiceAudios'
wavDir <- paste0(vaDir, '/wav')
rttmDir <- paste0(vaDir, '/rttm')
splitDir <- paste0(vaDir, '/split')
mxmlDir <- paste0(vaDir, '/musicxml')
ifelse(!dir.exists(vaDir), dir.create(vaDir), 'Directory exists!')
ifelse(!dir.exists(wavDir), dir.create(wavDir), 'Directory exists!')
ifelse(!dir.exists(rttmDir), dir.create(rttmDir), 'Directory exists!')
ifelse(!dir.exists(splitDir), dir.create(splitDir), 'Directory exists!')
ifelse(!dir.exists(mxmlDir), dir.create(mxmlDir), 'Directory exists!')
```

### Get audios
```{r}
url0 <- 'https://github.com/filipezabala/voiceAudios/raw/main/wav/bebezinho_2.0005.wav'
download.file(url0, paste0(wavDir, '/bebezinho_2.0005.wav'), mode = 'wb')
```
### Extract features
```{r}
ef <- voice::extract_features(wavDir, features = c('f0','formants','gain'),
                              round.to = 6, windowShift = 5)
ef
```
### Convolute
```{r}
(ef01 <- voice::conv_df(ef, .01)) # 1%
```
### Assign notes
```{r}
spn <- lapply(ef01[2:10], voice::notes)
spn <- bind_rows(spn)
colnames(spn) <- paste0('spn_', colnames(spn))
ef01 <- bind_cols(ef01, spn)

midi <- lapply(ef01[2:10], voice::notes, method = 'midi')
midi <- bind_rows(midi)
colnames(midi) <- paste0('midi_', colnames(midi))
ef01 <- bind_cols(ef01, midi)
glimpse(ef01)
```
### Distance (in semitones)
```{r}
nd.spn <- music::noteDistance(as.character(ef01$spn_F0))
table(nd.spn) # semitones
```
### Get duration
```{r}
dur.spn <- voice::duration(ef01$spn_F0)
dur.midi <- voice::duration(ef01$midi_F0)
```
### Play
```{r}
music::playNote(note = as.character(dur.spn$note),
                duration = dur.spn$dur_line)
```
### Partiture
```{r}
m <- gm::Music()
m <- m +
  # add a 4/4 time signature
  gm::Meter(4, 4) +
  # manually adding midi notes
  gm::Line(pitches = list(51, 53, 61, 58),
       durations = list(1,1,1,1))
m
export(m, mxmlDir, 'bebezinho', 'musicxml', '-r 200 -b 520')
```
![Just play 'bebezinho.musicxml' using MuseScore!](https://raw.githubusercontent.com/filipezabala/voice/master/vignettes/musescore.png){ width=75% }

## To do
- Automate argument `compact.to` at `voice::conv_df`
- Test weighting F0 considering GAIN and other features at `voice::conv_df`
- Test ZCR to infer BPM
- Automate `pitches` and `durations` at `gm::Line`
- Embed `gm::show` function
- Implement major/minor chords identifier (consider `tabr` functions)
- Must solve
  - Error in magick_image_write(image, format, quality, depth, density, comment,  : 
  rsession: NegativeOrZeroImageSize `' @ error/image.c/CloneImage/794
