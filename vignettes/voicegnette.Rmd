---
title: '`voice` vignette'
subtitle: 'version `r packageVersion("voice")`'
author: 'Filipe J. Zabala'
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{`voice` vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation
https://github.com/filipezabala/voice

## Example 1 - Play and get sheet music

### Load packages
```{r, message=FALSE, warning=FALSE}
# packs
library(voice)
library(tidyverse)
library(music)
library(gm)
```
### Set directories
The `/mp3` and `/split` directories will be used in Example 2.
```{r}
vaDir <- '~/Downloads/voiceAudios'
wavDir <- paste0(vaDir, '/wav')
mp3Dir <- paste0(vaDir, '/mp3')
rttmDir <- paste0(vaDir, '/rttm')
splitDir <- paste0(vaDir, '/split')
mxmlDir <- paste0(vaDir, '/musicxml')
ifelse(!dir.exists(vaDir), dir.create(vaDir), 'Directory exists!')
ifelse(!dir.exists(wavDir), dir.create(wavDir), 'Directory exists!')
ifelse(!dir.exists(mp3Dir), dir.create(mp3Dir), 'Directory exists!')
ifelse(!dir.exists(rttmDir), dir.create(rttmDir), 'Directory exists!')
ifelse(!dir.exists(splitDir), dir.create(splitDir), 'Directory exists!')
ifelse(!dir.exists(mxmlDir), dir.create(mxmlDir), 'Directory exists!')
```

### Remove old files (SENSIBLE STEP)
```{r}
cmd <- paste0('rm ', wavDir, '/*.*')
system(cmd)
```

#### To do #10 [WORK IN PROGRESS @ 2021-09-12 VERSION 0.0.0.9044]
Automatize and test `autoDir` argument @ splitw.R.  
Parameters fromWav, fromRttm admits either file or directory @ splitw.R.

### Get audios
```{r}
url0 <- 'http://www.filipezabala.com/audio/bebezinho_2005.wav'
download.file(url0, paste0(wavDir, '/bebezinho_2005.wav'), mode = 'wb')
# music::playWave(paste0(wavDir, '/bebezinho_2005.wav'))
```
#### To do #20
At `url0 <- 'https://github.com/filipezabala/voiceAudios/raw/main/bebezinho_2.005.wav'`, find out why the downloaded file is called `wav_bebezinho_2.005.wav`.

#### To do #30
Insert a button to play bebezinho_2005.wav.

### Extract features
```{r}
ef <- voice::extract_features(wavDir, features = c('f0','formants','gain'),
                              round.to = 6, windowShift = 5)
ef
```
#### To do #40
Automatize `stereo2mono`.

#### To do #50
Test different windowShift values.  

### Smooth
```{r}
for(i in seq(1,11,2)){
  name <- paste0('ef_sm_', i)
  assign(name, voice::smooth_df(ef, k = i))
}
```
#### To do #60 [DONE @ 2021-09-12 VERSION 0.0.0.9042]
Write the function `smooth_df(x,k)`.

### Plot F0 smoothing
```{r}
par(mfrow = c(2,3))
plot(ef_sm_1$F0, main = 'k = 1 (Original data)')
plot(ef_sm_3$F0, main = 'k = 3')
plot(ef_sm_5$F0, main = 'k = 5')
plot(ef_sm_7$F0, main = 'k = 7')
plot(ef_sm_9$F0, main = 'k = 9')
plot(ef_sm_11$F0, main = 'k = 11')
```


<!-- ### Pool -->
<!-- ```{r} -->
<!-- (ef01 <- voice::conv_df(ef, .01)) # 1% -->
<!-- ``` -->
<!-- #### To do -->
<!-- 1. Eliminate this step, assigning notes and durations after smooth with moving average.   -->
<!-- 2. Apply voice::duration over the smoothed data.   -->


### Assign notes
```{r}
spn <- lapply(ef_ma, voice::notes)
spn <- bind_rows(spn)
colnames(spn) <- paste0('spn_', colnames(spn))
ef_ma <- bind_cols(ef_ma, spn)

midi <- lapply(ef_ma, voice::notes, method = 'midi')
midi <- bind_rows(midi)
colnames(midi) <- paste0('midi_', colnames(midi))
ef_ma <- bind_cols(ef_ma, midi)

glimpse(ef_ma)
```

#### To do #60
Write plot function to show both frequency and notes in spn ana midi formats. Other formats?

#### To do #70
Write a function to, given a frequency in Hz, convert in any SPN.  

#### To do #80
Study chords (major/minor).  

#### To do #90
Study sequences (scales).  

### Plot
```{r}
plot(ef_ma$F0)
```

#### To do #100
Build a chart that merges frequency points and assigned notes. ('~/Dropbox/R/lolliplot.R')


### Distance (in semitones)
```{r}
nd.spn <- music::noteDistance(as.character(ef_ma$spn_F0))
nd.spn # semitones
table(nd.spn)
nd.midi <- diff(ef_ma$midi_F0)
nd.midi # semitones
table(nd.midi)
```

#### To do #110
Extract and test microtones. (Giuliano's idea.)
 

### Get duration
```{r}
dur.spn <- voice::duration(ef_ma$spn_F0)
dur.spn
dur.midi <- voice::duration(ef_ma$midi_F0)
dur.midi
```

<!-- ### Play -->
<!-- ```{r} -->
<!-- music::playNote(note = as.character(dur.spn$note), duration = dur.spn$dur_line) -->
<!-- ``` -->
<!-- #### To do -->
<!-- 1. Check version to play different durations.   -->

<!-- To do:   -->
<!-- 1. Solve in Linux:   -->

<!-- ```{r} -->
<!-- # ALSA lib pcm_dmix.c:1089:(snd_pcm_dmix_open) unable to open slave -->
<!-- # ALSA lib pcm.c:2642:(snd_pcm_open_noupdate) Unknown PCM cards.pcm.rear -->
<!-- # ALSA lib pcm.c:2642:(snd_pcm_open_noupdate) Unknown PCM cards.pcm.center_lfe -->
<!-- # ALSA lib pcm.c:2642:(snd_pcm_open_noupdate) Unknown PCM cards.pcm.side -->
<!-- # ALSA lib pcm_route.c:869:(find_matching_chmap) Found no matching channel map -->
<!-- # ALSA lib pcm_oss.c:377:(_snd_pcm_oss_open) Unknown field port -->
<!-- # ALSA lib pcm_oss.c:377:(_snd_pcm_oss_open) Unknown field port -->
<!-- # ALSA lib pulse.c:242:(pulse_connect) PulseAudio: Unable to connect: Connection refused -->
<!-- #  -->
<!-- # ALSA lib pulse.c:242:(pulse_connect) PulseAudio: Unable to connect: Connection refused -->
<!-- #  -->
<!-- # ALSA lib pcm_usb_stream.c:486:(_snd_pcm_usb_stream_open) Invalid type for card -->
<!-- # ALSA lib pcm_usb_stream.c:486:(_snd_pcm_usb_stream_open) Invalid type for card -->
<!-- # ALSA lib pcm_dmix.c:1089:(snd_pcm_dmix_open) unable to open slave -->
<!-- # ALSA lib pcm_dmix.c:1089:(snd_pcm_dmix_open) unable to open slave -->
<!-- ``` -->


### Music sheet
```{r}
m <- gm::Music()
m <- m +
  # add a 4/4 time signature
  gm::Meter(4, 4) +
  # manually adding midi notes
  gm::Line(pitches = list(51,50,49,48,47,NA,49,NA,58,59,60, 61,60,59,58,57,58,57,58,NA),
           durations=list( 2,30, 8, 8, 1,18,43,36, 1, 4, 9,101, 5, 4, 7, 9, 4,51,48,1))
m
show(m, to = c('score', 'audio'))
```
#### To do #120
Automate adding midi/spn notes pitches at `gm::Line`.

### Export musicxml file
```{r}
gm::export(m, mxmlDir, 'bebezinho', 'musicxml')
```




## Example 2 - Cut audios

### Get audios
```{r}
# font url
url0 <- 'https://github.com/filipezabala/voiceAudios/raw/main/mp3/'

# mp3 files
mp3Files <- c('anthem0.mp3', 'anthem1.mp3', 'anthem2.mp3',
              'game0.mp3', 'game1.mp3', 'game2.mp3',
              'phantom0.mp3', 'phantom1.mp3',  'phantom2.mp3',
              'romeo0.mp3', 'romeo1.mp3', 'romeo2.mp3',
              'sherlock0.mp3', 'sherlock1.mp3', 'sherlock2.mp3',
              'war0.mp3', 'war1.mp3', 'war2.mp3')

# downloading just the first mp3 file (remove [1] to download all)
for(i in mp3Files[1]){
  system(paste0('wget -r -np -k ', url0, i, ' -P ~/Downloads/voiceAudios/mp3'))
}

# tidying up files and directories
system('cp ~/Downloads/voiceAudios/mp3/github.com/filipezabala/voiceAudios/raw/main/mp3/*.* ~/Downloads/voiceAudios/mp3')
system('rm -rf ~/Downloads/voiceAudios/mp3/github.com/')
```

### Remove old files
```{r}
cmd <- paste0('rm ', wavDir, '/*.*')
system(cmd)
```

### Convert mp3 to wav
```{r}
cmd <- 'cd ~/Downloads/voiceAudios/mp3;
for i in *.[Mm][Pp]3; do ffmpeg -i "$i" "../wav/${i%.*}.wav"; done'
system(cmd)
```
#### To do #130
Automatize and test mp32wav.

#### To do #140
Test the hypotheses
H1: multiple mp32wav2mp32wav... conversions reduce the audio quality.
H2: What is the impact in the decision using 
 i. original wav
 ii. original mp3 (that must be converted to wav)
 iii. H1, if H1 is consistent


### Poetry
The best words in their best order. Takes around the audio time at 8CPU and the double of the audio time at 4CPU.
```{r}
voice::poetry(wavDir, pycall = '/home/linuxbrew/.linuxbrew/bin/python3.9') # Linux
# voice::poetry(wavDir, to = rttmDir, pycall = '~/miniconda3/envs/pyvoice38/bin/python3.8') # Mac
```
![](rttm.png)
#### To do #150
Automate speaker recognition (who speaks when?).

### Split wave
```{r}
# split wave
ini <- Sys.time()
voice::splitw(wavDir, fromRttm = rttmDir, to = splitDir)
Sys.time()-ini
```
![](split.png)

#### To do #160 [SOLVED @ 2021-08-16 VERSION 0.0.0.35]
Automate argument `compact.to` at `voice::conv_df`. 

#### To do #170 [TESTED: NOK WITH GAIN]
No gain testing weighting F0 considering GAIN and other features at `voice::conv_df`.
[TEST1] No gain testing weighting F0 considering GAIN.

#### To do #180
Test ZCR to infer BPM.

#### To do #190 [WORK IN PROGRESS]
Automate `pitches` and `durations` at `gm::Line`.

#### To do #200
Implement major/minor chords identifier (consider `tabr` functions).

#### To do #210
Embed `gm::show` function at MacOS. Must solve:
  - Error in magick_image_write(image, format, quality, depth, density, comment,  : 
  rsession: NegativeOrZeroImageSize `' @ error/image.c/CloneImage/794

#### To do #220
Find the 'best' set of variables in different contexts.

#### To do #230
Automate `min.time` argument at `voice::splitw`.

## GLOSSARY
. [WORK IN PROGRESS] As it says, support is welcome.
. [SOLVED @ '%Y-%m-%d' VERSION major.minor.subminor]
. [TESTED: NOK] During the tests no gain were obtained.
